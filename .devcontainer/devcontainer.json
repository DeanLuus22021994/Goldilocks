{
  "name": "Goldilocks Development Environment",
  "image": "goldilocks:devcontainer",
  "workspaceFolder": "/workspaces/Goldilocks",
  "remoteUser": "app",

  "hostRequirements": {
    "gpu": "optional",
    "storage": "32gb",
    "memory": "8gb",
    "cpus": 4
  },

  "runArgs": [
    "--gpus=all",
    "--shm-size=2g",
    "--ipc=host",
    "--ulimit=memlock=-1",
    "--ulimit=stack=67108864",
    "--device=/dev/dri"
  ],

  "containerEnv": {
    "FLASK_APP": "src/goldilocks/app.py",
    "FLASK_ENV": "development",
    "FLASK_DEBUG": "1",
    "PYTHONPATH": "/workspaces/Goldilocks/src",
    "PYTHONUNBUFFERED": "1",
    "NVIDIA_VISIBLE_DEVICES": "all",
    "NVIDIA_DRIVER_CAPABILITIES": "compute,utility,graphics",
    "DATABASE_URL": "mysql+pymysql://goldilocks_user:goldilocks_pass_2024@localhost:3306/goldilocks",
    "DB_HOST": "localhost",
    "DB_PORT": "3306",
    "DB_NAME": "goldilocks",
    "DB_USER": "goldilocks_user",
    "DB_PASSWORD": "goldilocks_pass_2024"
  },

  "mounts": [
    "source=goldilocks-venv,target=/opt/venv,type=volume",
    "source=vscode-server-cache,target=/home/app/.vscode-server,type=volume",
    "source=pip-cache,target=/home/app/.cache/pip,type=volume",
    "source=npm-cache,target=/home/app/.npm,type=volume",
    "source=pre-commit-cache,target=/home/app/.cache/pre-commit,type=volume",
    "source=mypy-cache,target=/home/app/.mypy_cache,type=volume"
  ],

  "initializeCommand": "docker volume create goldilocks-venv && docker volume create vscode-server-cache && docker volume create pip-cache && docker volume create npm-cache && docker volume create pre-commit-cache && docker volume create mypy-cache",

  "postCreateCommand": "sudo chown -R app:app /workspaces/Goldilocks && sudo chmod -R u+w /workspaces/Goldilocks/.git",

  "customizations": {
    "vscode": {
      "extensions": [
        "ms-python.python",
        "ms-python.vscode-pylance",
        "tamasfe.even-better-toml"
      ],
      "settings": {
        "python.defaultInterpreterPath": "/opt/venv/bin/python",
        "git.repositorySearchDepth": 1,
        "git.autoRepositoryDetection": true
      }
    }
  },

  "forwardPorts": [9000, 3306, 8080],
  "portsAttributes": {
    "9000": {
      "label": "Flask App",
      "onAutoForward": "notify"
    },
    "3306": {
      "label": "MariaDB",
      "onAutoForward": "silent"
    },
    "8080": {
      "label": "Adminer",
      "onAutoForward": "notify"
    }
  },
  "shutdownAction": "stopContainer",

  "features": {
    "ghcr.io/devcontainers/features/git:1": {
      "ppa": false,
      "version": "latest"
    }
  }
}
