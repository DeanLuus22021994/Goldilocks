{# Form Dialog Component Usage: {% include 'dialog/form.html' with {'id':
'formDialog', 'title': 'Edit Item', 'form_action': '/api/update', 'fields':
[...]} %} #}

<div class="dialog-overlay" id="{{ id or 'formDialog' }}" style="display: none">
  <div class="dialog-container dialog-md">
    <div class="dialog-content">
      <div class="dialog-header">
        <h2 class="dialog-title">{{ title or 'Form' }}</h2>
        <button
          type="button"
          class="dialog-close"
          onclick="closeFormDialog('{{ id or 'formDialog' }}')"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="dialog-body">
        <form
          id="{{ id or 'formDialog' }}Form"
          method="{{ method or 'POST' }}"
          action="{{ form_action or '#' }}"
        >
          {% if csrf_token %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
          {% endif %} {% if fields %} {% for field in fields %} {% include
          'components/form-input.html' with field %} {% endfor %} {% else %} {%
          block form_fields %}
          <div class="form-group">
            <label for="example_field" class="form-label">Example Field</label>
            <input
              type="text"
              id="example_field"
              name="example_field"
              class="form-control"
              placeholder="Enter value"
            />
          </div>
          {% endblock %} {% endif %}
        </form>
      </div>

      <div class="dialog-footer">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="closeFormDialog('{{ id or 'formDialog' }}')"
        >
          {{ cancel_text or 'Cancel' }}
        </button>
        <button
          type="submit"
          form="{{ id or 'formDialog' }}Form"
          class="btn btn-primary"
        >
          {{ submit_text or 'Save' }}
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function openFormDialog(dialogId, data = {}) {
    const dialog = document.getElementById(dialogId);
    if (dialog) {
      dialog.style.display = "flex";
      document.body.style.overflow = "hidden";

      // Populate form fields with data if provided
      if (data && Object.keys(data).length > 0) {
        const form = dialog.querySelector("form");
        for (const [key, value] of Object.entries(data)) {
          const field = form.querySelector(`[name="${key}"]`);
          if (field) {
            field.value = value;
          }
        }
      }

      // Focus the first input
      const firstInput = dialog.querySelector("input, select, textarea");
      if (firstInput) {
        firstInput.focus();
      }
    }
  }

  function closeFormDialog(dialogId) {
    const dialog = document.getElementById(dialogId);
    if (dialog) {
      dialog.style.display = "none";
      document.body.style.overflow = "";

      // Reset form
      const form = dialog.querySelector("form");
      if (form) {
        form.reset();
      }
    }
  }

  // Handle form submission
  document.addEventListener("submit", function (e) {
    const form = e.target;
    if (form.closest(".dialog-overlay")) {
      e.preventDefault();

      const formData = new FormData(form);
      const submitButton =
        form.parentElement.parentElement.querySelector('[type="submit"]');

      if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner"></span> Saving...';
      }

      fetch(form.action, {
        method: form.method,
        body: formData,
      })
        .then((response) => {
          if (response.ok) {
            closeFormDialog(form.closest(".dialog-overlay").id);
            showAlert("Success", "Form submitted successfully!", "success");

            // Trigger custom event for parent page to handle
            document.dispatchEvent(
              new CustomEvent("formSubmitted", {
                detail: { formId: form.id, response: response },
              })
            );
          } else {
            throw new Error("Submission failed");
          }
        })
        .catch((error) => {
          console.error("Form submission error:", error);
          showAlert(
            "Error",
            "Failed to submit form. Please try again.",
            "error"
          );
        })
        .finally(() => {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = "Save";
          }
        });
    }
  });
</script>

<style>
  .dialog-body .form-group:last-child {
    margin-bottom: 0;
  }

  /* Spinner for submit button */
  .spinner {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 1px solid transparent;
    border-top: 1px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: var(--space-2);
  }
</style>
